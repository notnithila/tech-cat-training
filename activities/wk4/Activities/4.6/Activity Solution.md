# Activity 4.6 Solution

```sql
USE ROLE de;
USE WAREHOUSE COMPUTE_WH;

CREATE OR REPLACE TRANSIENT TABLE TECHCATALYST_DE.TATWAN.STOCKS
(
 	DATE DATE,
	OPEN NUMBER(38,15),
	HIGH NUMBER(38,15),
	LOW NUMBER(38,15),
	CLOSE NUMBER(38,15),
	ADJCLOSE NUMBER(38,15),
	VOLUME NUMBER(38,0),
    STOCK_NAME STRING
);

show stages;

LIST @TECHCATALYST_DE.EXTERNAL_STAGE.TATWAN_STAGE;

USE SCHEMA TECHCATALYST_DE.EXTERNAL_STAGE;

INSERT INTO TECHCATALYST_DE.TATWAN.STOCKS
(ADJCLOSE, CLOSE, DATE, HIGH, LOW, OPEN, VOLUME, STOCK_NAME)
SELECT 
value:"Adj Close"::NUMBER(38,15) as ADJCLOSE
,value:Close::NUMBER(38,15) as CLOSE
,TO_DATE(value:"Date"::STRING) as "DATE"
,value:High::NUMBER(38,15) as HIGH
,value:Low::NUMBER(38,15) as LOW
,value:Open::NUMBER(38,15) as OPEN
,value:Volume::NUMBER(38,15) as VOLUME
,'GE' as STOCK_NAME
FROM 
    @TATWAN_STAGE/stocks/ge.json
    (FILE_FORMAT => 'techcatalyst_de.external_stage.tatwan_json_format')
, LATERAL FLATTEN(input => PARSE_JSON($1));

SELECT STOCK_NAME, COUNT(*)
FROM TECHCATALYST_DE.TATWAN.STOCKS
GROUP BY STOCK_NAME;

INSERT INTO TECHCATALYST_DE.TATWAN.STOCKS
(ADJCLOSE, CLOSE, DATE, HIGH, LOW, OPEN, VOLUME, STOCK_NAME)
SELECT 
 $1:"Adj Close"::NUMBER(38,15) as ADJCLOSE
,$1:Close::NUMBER(38,15) as CLOSE
,TO_DATE($1:"Date"::STRING) as "DATE"
,$1:High::NUMBER(38,15) as HIGH
,$1:Low::NUMBER(38,15) as LOW
,$1:Open::NUMBER(38,15) as OPEN
,$1:Volume::NUMBER(38,15) as VOLUME
,'AAPL' as STOCK_NAME
FROM @TATWAN_STAGE/stocks/aapl.parquet
    (FILE_FORMAT => 'techcatalyst_de.external_stage.tatwan_parquet_format') ;



select stock_name, count(*) 
from TECHCATALYST_DE.TATWAN.STOCKS
group by 1;


CREATE OR REPLACE FILE FORMAT tatwan_csv_header_format
TYPE = 'CSV'
FIELD_OPTIONALLY_ENCLOSED_BY = '"';

SELECT $1, $2, $3, $4, $5, $6, $7
FROM @TATWAN_STAGE/stocks/goog.csv
    (FILE_FORMAT => 'techcatalyst_de.external_stage.tatwan_csv_header_format') limit 1;


INSERT INTO TECHCATALYST_DE.TATWAN.STOCKS
(ADJCLOSE, CLOSE, DATE, HIGH, LOW, OPEN, VOLUME, STOCK_NAME)
SELECT 
 $6::NUMBER(38,15) as ADJCLOSE
,$5::NUMBER(38,15) as CLOSE
,TO_DATE($1::STRING) as "DATE"
,$3::NUMBER(38,15) as HIGH
,$4::NUMBER(38,15) as LOW
,$2::NUMBER(38,15) as OPEN
,$7::NUMBER(38,15) as VOLUME
,'GOOG' as STOCK_NAME
FROM @TATWAN_STAGE/stocks/goog.csv
    (FILE_FORMAT => 'techcatalyst_de.external_stage.tatwan_csv_format') ;


select stock_name, count(*) from TECHCATALYST_DE.TATWAN.STOCKS
group by 1;



SELECT 
    STOCK_NAME,
    DATE, 
    CLOSE,
    LAG(CLOSE) OVER (PARTITION BY stock_name ORDER BY DATE) AS PREV_CLOSE,
    ((CLOSE - PREV_CLOSE) /PREV_CLOSE) * 100 AS PCT_CHANGE
FROM 
    TECHCATALYST_DE.TATWAN.STOCKS
-- WHERE STOCK_NAME = 'AAPL'
ORDER BY 
    STOCK_NAME, DATE;


SELECT 
    STOCK_NAME,
    DATE, 
    CLOSE,
    AVG(CLOSE) OVER (PARTITION BY stock_name ORDER BY DATE ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS MOVING_AVG_30D
FROM 
    TECHCATALYST_DE.TATWAN.STOCKS
-- WHERE STOCK_NAME = 'AAPL'
ORDER BY 
    STOCK_NAME, DATE;



 
```

